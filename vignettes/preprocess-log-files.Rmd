---
title: "Preprocessing of log files"
author: "Bram B. Zandbelt"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteDepends{magrittr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Preliminaries
```{r}
"%>%" <- magrittr::`%>%`
```


## Identify the project directory
All paths in the code are relative to the project directory.
```{r}
project_dir <- rprojroot::find_root(rprojroot::has_file("DESCRIPTION"))
```

## Verify existence of output directories
```{r}

derivatives_dir <- file.path(project_dir,"data","derivatives")
figures_dir <- file.path(project_dir,"data","reports","figures")
notebook_name <- "preprocess_log_files"

irmass::verify_output_dirs(base_dirs = list(derivatives_dir, figures_dir),
                           notebook_name = notebook_name)
```

# Read data

## Select log files
```{r}
prac_trial_files <- irmass::select_log_files(stage = "practice", 
                                             filetype = "triallog")
prac_block_files <- irmass::select_log_files(stage = "practice", 
                                             filetype = "blocklog")
expt_trial_files <- irmass::select_log_files(stage = "experiment", 
                                             filetype = "triallog")
expt_block_files <- irmass::select_log_files(stage = "experiment", 
                                             filetype = "blocklog")
```

## Read log files
We read the four types of log files (practice blocklog, practice triallog, experiment blocklog, experiment triallog) of all participants into a tibble using `readr::read_csv`.

This results in some warnings, because the blocklog files happened to have a column with zeros and no column name. This warning can be ignored and therefore they are not explicitly shown.
```{r, warning = FALSE}

prac_sess_data <- irmass::read_log_files(prac_trial_files, data_type = "sess_data")
prac_block_data <- irmass::read_log_files(prac_block_files, data_type = "block_data")
prac_trial_data <- irmass::read_log_files(prac_trial_files, data_type = "trial_data")

expt_sess_data <- irmass::read_log_files(expt_block_files, data_type = "sess_data")
expt_block_data <- irmass::read_log_files(expt_block_files, data_type = "block_data")
expt_trial_data_others <- irmass::read_log_files(expt_trial_files$others, data_type = "trial_data")
expt_trial_data_sub00 <- irmass::read_log_files(expt_trial_files$subj00, data_type = "trial_data_sub00")

```

# Data cleaning
Data clearning involves the following (high-level) steps:
- correction of erroneous columns names in the experimental triallog file from participant subj00, and merge data with data from other participants
- remove practice trials from experimental session

- do some renaming, mutating, etc.

- tidy the data (see Wickham, J Stat Software, 2014)


## Correct erroneous column names in experimental triallog file of sub-00
During the experimental session, participant subj00 practiced the task outside the MRI scanner, using a keyboard rather than the MR-compatible response pad. As a result, this subject's experiment triallog variable names related to key presses reflect the keyboard mapping (LM = f, RM = h, LI = v, RI = b) rather than the response pad mapping (LM = f, RM = b, LI = e, RI = a). The procedure below for subj00 corrects this issue.

```{r}
expt_trial_data_sub00 <- 
expt_trial_data_sub00 %>%
  dplyr::rename(keyCount_a = keyCount_b,
                rt1_a = rt1_b,
                keyCount_e = keyCount_v,
                rt1_e = rt1_v,
                keyCount_b = keyCount_h,
                rt1_b = rt1_h,
                `rtDiff1_f-b` = `rtDiff1_f-h`,
                `rtDiff1_e-a` = `rtDiff1_v-b`,
         )
```

Now, merge sub-00's experimental trial data with that from the others

```{r}
expt_trial_data <- rbind(expt_trial_data_sub00,expt_trial_data_others)
```

## Remove practice blocks/trials data from experimental session data

```{r}
expt_block_data <- 
  expt_block_data %>%
  dplyr::filter(stringr::str_detect(blockId, '^e.*'))

expt_trial_data <- 
  expt_trial_data %>%
  dplyr::filter(stringr::str_detect(blockId, '^e.*'))
```

## Verify index columns
Columns with column names ending in 'Ix' are index columns. The values in these columns should be of integer type, but are not when NaNs are present. The following code identifies index columns, replaces NaNs with NAs and ensures that the values are coded as integers.

```{r}

# Index columns (*Ix) should be coded as integers
list2env(purrr::map(list(prac_sess_data = prac_sess_data, 
                         prac_block_data = prac_block_data, 
                         prac_trial_data = prac_trial_data, 
                         expt_sess_data = expt_sess_data,
                         expt_block_data = expt_block_data,
                         expt_trial_data = expt_trial_data), 
                    irmass::verify_ix_cols),
         envir = parent.frame()
         )

```

## Reorganize and tidy data data
The block data is used to determine whether or not performance was in line with preset criteria.

Tidy data has the following characteristics:

- each variable forms one column
- each observation forms one row
- each type of observational unit forms a table

Tidy data aids data analysis and data visualization.

### Reorganize and tidy data block data

```{r}

prac_block_data_tidied <- irmass::tidy_block_data(prac_block_data)
expt_block_data_tidied <- irmass::tidy_block_data(expt_block_data)

```
#### Print tidied block data for a quick peek
```{r}

prac_block_data_tidied
expt_block_data_tidied

```

### Reorganize and tidy data block data

```{r}

prac_trial_data_tidied <- irmass::tidy_trial_data(prac_trial_data)
expt_trial_data_tidied <- irmass::tidy_trial_data(expt_trial_data)

```

#### Print tidied experiment trial data for a quick peek
```{r}
expt_trial_data_tidied$RT_df
expt_trial_data_tidied$resp_df
```

## Encode `trial`, `t_d`, and `t_d_alt` as factors

```{r}

# factorize_tidy_data <- function(df) {
#   
#   if (any(stringr::str_detect(colnames(df),"^trial$"))) {
#     df$trial <- 
#       factor(df$trial,
#              levels = c("NS", "SL", "SR", "SB", "IG"),
#              labels = c("no-signal", "stop-left", "stop-right", "stop-both", "ignore")
#              )
#     
#     
#     df$trial_alt <-
#       forcats::fct_collapse(df$trial,
#                             no_signal = "NS",
#                             action_selective_stop_signal = c("SL","SR"),
#                             stimulus_selective_stop_signal = "SB"
#                             )
#       
#     
#   }
#   
#   if (any(stringr::str_detect(colnames(df),"^t_d$"))) {
#     df$t_d <- 
#       factor(df$t_d,
#              levels = c("short", "intermediate", "long"),
#              labels = c("short", "intermediate", "long")
#              )
#   }
#   
#   if (any(stringr::str_detect(colnames(df),"^t_d_alt$"))) {
#     df$t_d_alt <- 
#       factor(df$t_d_alt,
#              levels = c("short", "intermediate", "long"),
#              labels = c("short", "intermediate", "long")
#              )
#   }
#   
# }

expt_trial_data_tidied$RT_df$trial <- 
  factor(expt_trial_data_tidied$RT_df$trial,
         
         )

expt_trial_data_tidied$RT_df$trial <- 
  factor(expt_trial_data_tidied$RT_df$trial,
         levels = c("NS","SL","SR","SB","IG"),
         labels = c("no-signal", "stop-left", "stop-right", "stop-both", "ignore")
         )

```


# Descriptive statistics

```{r rows.print=36, caption = "bla"}
irmass::show_trial_numbers(expt_trial_data_tidied$RT_df)

```

# Inferential statistics
None.

# Data visualization
Some waffle plots?

# Write data

```{r Write tidied and preprocessed block and trial data}

readr::write_csv(prac_block_data_tidied,
                 path = file.path(derivatives_dir, 
                                  notebook_name, 
                                  'tidy_prac_block_data.csv'),
                 col_names = TRUE)

readr::write_csv(expt_block_data_tidied,
                 path = file.path(derivatives_dir, 
                                  notebook_name, 
                                  'tidy_expt_block_data.csv'),
                 col_names = TRUE)

readr::write_csv(prac_trial_data_tidied$resp_df,
                 path = file.path(derivatives_dir, 
                                  notebook_name, 
                                  'tidy_prac_trial_resp_data.csv'),
                 col_names = TRUE)

readr::write_csv(prac_trial_data_tidied$RT_df,
                 path = file.path(derivatives_dir, 
                                  notebook_name, 
                                  'tidy_prac_trial_rt_data.csv'),
                 col_names = TRUE)

readr::write_csv(expt_trial_data_tidied$resp_df,
                 path = file.path(derivatives_dir, 
                                  notebook_name, 
                                  'tidy_expt_trial_resp_data.csv'),
                 col_names = TRUE)

readr::write_csv(expt_trial_data_tidied$RT_df,
                 path = file.path(derivatives_dir, 
                                  notebook_name, 
                                  'tidy_expt_trial_rt_data.csv'),
                 col_names = TRUE)
          

```



